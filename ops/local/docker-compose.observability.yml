# ============================================
# MADFAM OBSERVABILITY STACK
# ============================================
# Self-hosted PostHog for product analytics
# Dogfoods Enclii deployment capabilities
# ============================================

name: madfam-observability

services:
  # ==========================================
  # PostHog - Product Analytics Platform
  # ==========================================
  posthog:
    image: posthog/posthog:latest
    container_name: madfam-posthog
    depends_on:
      posthog-postgres:
        condition: service_healthy
      posthog-redis:
        condition: service_healthy
      posthog-clickhouse:
        condition: service_healthy
      posthog-kafka:
        condition: service_healthy
    environment:
      # Database
      DATABASE_URL: postgres://posthog:posthog_dev@posthog-postgres:5432/posthog

      # Redis
      REDIS_URL: redis://posthog-redis:6379/

      # ClickHouse
      CLICKHOUSE_HOST: posthog-clickhouse
      CLICKHOUSE_DATABASE: posthog
      CLICKHOUSE_SECURE: "false"
      CLICKHOUSE_VERIFY: "false"

      # Kafka
      KAFKA_HOSTS: posthog-kafka:9092

      # PostHog Config
      SECRET_KEY: ${POSTHOG_SECRET_KEY:-phog-dev-secret-key-change-in-production}
      SITE_URL: ${POSTHOG_SITE_URL:-http://localhost:8100}
      IS_BEHIND_PROXY: "true"
      DISABLE_SECURE_SSL_REDIRECT: "true"

      # Feature Flags
      POSTHOG_PERSONAL_API_KEY: ${POSTHOG_PERSONAL_API_KEY:-}

      # Async Processing
      ASYNC_EVENT_PROPERTY_USAGE: "true"

      # Email (use shared MailHog)
      EMAIL_HOST: madfam-mailhog
      EMAIL_PORT: 1025
      EMAIL_USE_TLS: "false"
      EMAIL_USE_SSL: "false"
      DEFAULT_FROM_EMAIL: posthog@madfam.local
    ports:
      - "8100:8000"
    volumes:
      - posthog_data:/var/lib/posthog
    networks:
      - madfam-observability-network
      - madfam-shared-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/_health/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================
  # PostHog Worker - Background Processing
  # ==========================================
  posthog-worker:
    image: posthog/posthog:latest
    container_name: madfam-posthog-worker
    command: ./bin/docker-worker-celery --with-scheduler
    depends_on:
      posthog:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://posthog:posthog_dev@posthog-postgres:5432/posthog
      REDIS_URL: redis://posthog-redis:6379/
      CLICKHOUSE_HOST: posthog-clickhouse
      CLICKHOUSE_DATABASE: posthog
      CLICKHOUSE_SECURE: "false"
      CLICKHOUSE_VERIFY: "false"
      KAFKA_HOSTS: posthog-kafka:9092
      SECRET_KEY: ${POSTHOG_SECRET_KEY:-phog-dev-secret-key-change-in-production}
    networks:
      - madfam-observability-network
      - madfam-shared-network
    restart: unless-stopped

  # ==========================================
  # PostHog Plugins - Plugin Server
  # ==========================================
  posthog-plugins:
    image: posthog/posthog:latest
    container_name: madfam-posthog-plugins
    command: ./bin/plugin-server --no-restart-loop
    depends_on:
      posthog:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://posthog:posthog_dev@posthog-postgres:5432/posthog
      REDIS_URL: redis://posthog-redis:6379/
      CLICKHOUSE_HOST: posthog-clickhouse
      CLICKHOUSE_DATABASE: posthog
      CLICKHOUSE_SECURE: "false"
      CLICKHOUSE_VERIFY: "false"
      KAFKA_HOSTS: posthog-kafka:9092
      SECRET_KEY: ${POSTHOG_SECRET_KEY:-phog-dev-secret-key-change-in-production}
    networks:
      - madfam-observability-network
      - madfam-shared-network
    restart: unless-stopped

  # ==========================================
  # PostgreSQL for PostHog
  # ==========================================
  posthog-postgres:
    image: postgres:15-alpine
    container_name: madfam-posthog-postgres
    environment:
      POSTGRES_USER: posthog
      POSTGRES_PASSWORD: posthog_dev
      POSTGRES_DB: posthog
    volumes:
      - posthog_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U posthog -d posthog"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - madfam-observability-network
    restart: unless-stopped

  # ==========================================
  # Redis for PostHog
  # ==========================================
  posthog-redis:
    image: redis:7-alpine
    container_name: madfam-posthog-redis
    command: redis-server --appendonly yes
    volumes:
      - posthog_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - madfam-observability-network
    restart: unless-stopped

  # ==========================================
  # ClickHouse for PostHog Analytics
  # ==========================================
  posthog-clickhouse:
    image: clickhouse/clickhouse-server:23.11-alpine
    container_name: madfam-posthog-clickhouse
    environment:
      CLICKHOUSE_DB: posthog
      CLICKHOUSE_USER: posthog
      CLICKHOUSE_PASSWORD: clickhouse_dev
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - posthog_clickhouse_data:/var/lib/clickhouse
      - ./clickhouse/users.xml:/etc/clickhouse-server/users.d/users.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - madfam-observability-network
    restart: unless-stopped

  # ==========================================
  # Kafka for PostHog Events
  # ==========================================
  posthog-zookeeper:
    image: bitnami/zookeeper:3.9
    container_name: madfam-posthog-zookeeper
    environment:
      ALLOW_ANONYMOUS_LOGIN: "yes"
    volumes:
      - posthog_zookeeper_data:/bitnami/zookeeper
    networks:
      - madfam-observability-network
    restart: unless-stopped

  posthog-kafka:
    image: bitnami/kafka:3.6
    container_name: madfam-posthog-kafka
    depends_on:
      - posthog-zookeeper
    environment:
      KAFKA_CFG_ZOOKEEPER_CONNECT: posthog-zookeeper:2181
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://posthog-kafka:9092
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - posthog_kafka_data:/bitnami/kafka
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - madfam-observability-network
    restart: unless-stopped

# ==========================================
# Networks
# ==========================================
networks:
  madfam-observability-network:
    name: madfam-observability-network
    driver: bridge
  madfam-shared-network:
    external: true

# ==========================================
# Volumes
# ==========================================
volumes:
  posthog_data:
    name: madfam-posthog-data
  posthog_postgres_data:
    name: madfam-posthog-postgres-data
  posthog_redis_data:
    name: madfam-posthog-redis-data
  posthog_clickhouse_data:
    name: madfam-posthog-clickhouse-data
  posthog_zookeeper_data:
    name: madfam-posthog-zookeeper-data
  posthog_kafka_data:
    name: madfam-posthog-kafka-data
